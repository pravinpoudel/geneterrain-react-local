"use strict";exports.__esModule=!0;var terrain_generator_1=require("./terrain_generator"),wgsl_1=require("./wgsl"),Renderer=function(){function e(e,a,n,t){if(this.uniform2DBuffer=null,this.terrainGenerator=null,this.bindGroup2D=null,this.nodeBindGroup=null,this.nodePositionBuffer=null,this.nodePipeline=null,this.nodeLength=1,this.device=a,null!==n.current){var o=n.current.getContext("webgpu"),r=window.devicePixelRatio||1,i=[n.current.clientWidth*r,n.current.clientHeight*r],u=o.getPreferredFormat(e);o.configure({device:a,format:u,size:i}),this.nodePositionBuffer=a.createBuffer({size:48,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.nodePositionBuffer.getMappedRange()).set([1,-1,-1,-1,-1,1,1,-1,-1,1,1,1]),this.nodePositionBuffer.unmap(),this.nodePipeline=a.createRenderPipeline({vertex:{module:a.createShaderModule({code:wgsl_1.node_vert}),entryPoint:"main",buffers:[{arrayStride:8,attributes:[{format:"float32x2",offset:0,shaderLocation:0}]}]},fragment:{module:a.createShaderModule({code:wgsl_1.node_frag}),entryPoint:"main",targets:[{format:u}]},primitive:{topology:"triangle-list"},depthStencil:{format:"depth24plus-stencil8",depthWriteEnabled:!0,depthCompare:"less"}});var s=a.createRenderPipeline({vertex:{module:a.createShaderModule({code:wgsl_1.display_2d_vert}),entryPoint:"main",buffers:[{arrayStride:16,attributes:[{format:"float32x4",offset:0,shaderLocation:0}]}]},fragment:{module:a.createShaderModule({code:wgsl_1.display_2d_frag}),entryPoint:"main",targets:[{format:u}]},primitive:{topology:"triangle-list"},depthStencil:{format:"depth24plus-stencil8",depthWriteEnabled:!0,depthCompare:"less"}}),f=a.createBuffer({size:96,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(f.getMappedRange()).set([1,-1,0,1,-1,-1,0,1,-1,1,0,1,1,-1,0,1,-1,1,0,1,1,1,0,1]),f.unmap(),this.uniform2DBuffer=a.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a.queue.writeBuffer(this.uniform2DBuffer,0,new Float32Array([.8,.2]),0,2);var d=a.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0});new Uint32Array(d.getMappedRange()).set(i),d.unmap();a.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});var l=a.createTexture({size:[t.width,t.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});a.queue.copyExternalImageToTexture({source:t},{texture:l},[t.width,t.height,1]);var p=a.createTexture({size:{width:i[0],height:i[1],depthOrArrayLayers:1},format:"depth24plus-stencil8",usage:GPUTextureUsage.RENDER_ATTACHMENT});this.terrainGenerator=new terrain_generator_1.default(a,i[0],i[1]),this.bindGroup2D=a.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:l.createView()},{binding:1,resource:{buffer:this.terrainGenerator.pixelValueBuffer}},{binding:2,resource:{buffer:this.uniform2DBuffer}},{binding:3,resource:{buffer:d}}]});var g=this;requestAnimationFrame(function e(){if(n.current){var t=a.createCommandEncoder(),r={colorAttachments:[{view:o.getCurrentTexture().createView(),loadValue:{r:.157,g:.173,b:.204,a:1},storeOp:"store"}],depthStencilAttachment:{view:p.createView(),depthLoadValue:1,depthStoreOp:"store",stencilLoadValue:0,stencilStoreOp:"store"}},i=t.beginRenderPass(r);i.setPipeline(s),i.setVertexBuffer(0,f),i.setBindGroup(0,g.bindGroup2D),i.draw(6,1,0,0),i.setPipeline(g.nodePipeline),i.setVertexBuffer(0,g.nodePositionBuffer),i.draw(6*g.nodeLength,1,0,0),i.endPass(),a.queue.submit([t.finish()]),requestAnimationFrame(e)}})}}return e.prototype.setNodeData=function(e){this.terrainGenerator.computeTerrain(e);for(var t=[],r=.01,i=0;i<e.length;i+=4){var a=2*e[i+1]-1,n=2*e[i+2]-1;t.push(a+r,n-r,a-r,n-r,a-r,n+r,a+r,n-r,a-r,n+r,a+r,n+r)}this.nodePositionBuffer=this.device.createBuffer({size:4*t.length,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.nodePositionBuffer.getMappedRange()).set(t),this.nodePositionBuffer.unmap(),this.nodeLength=e.length/4},e.prototype.setWidthFactor=function(e){this.terrainGenerator.computeTerrain(void 0,e)},e.prototype.setPeakValue=function(e){this.device.queue.writeBuffer(this.uniform2DBuffer,0,new Float32Array([e]),0,1)},e.prototype.setValleyValue=function(e){this.device.queue.writeBuffer(this.uniform2DBuffer,4,new Float32Array([e]),0,1)},e}();exports.default=Renderer;
//# sourceMappingURL=render.min.js.map
